# 多用户支持方案

## 现状分析

### 已支持

- **会话隔离（按 chatId）**：`sessions` Map 以 `chatId` 为 key，不同聊天窗口各自维护独立 Claude 会话
- **并发控制（按 chatId）**：`processing` Set 防止同一聊天内并发请求
- **私聊 + 群聊**：私聊和群聊都能响应，群聊只响应 @机器人的消息

### 不足

| 问题 | 说明 |
|------|------|
| 工作目录共享 | 所有用户共用 `config.workspace`，文件操作互相影响 |
| 群聊无用户级隔离 | 同一群里多人共享 Claude 会话，`/clear` 会影响所有人 |
| 群聊并发阻塞 | 按 `chatId` 加锁，群聊中一人使用时其他人被阻塞 |
| 用户身份未传递 | `senderId` 仅用于日志，未传给 Claude |

### 多用户场景支持情况

| 场景 | 是否支持 |
|------|---------|
| 多个私聊用户同时使用 | 支持（各自独立 chatId） |
| 同一群里多人使用 | 不支持（共享会话，互相干扰） |
| 用户级工作目录隔离 | 不支持（共用一个目录） |

## 方案对比

### 方案一：代码层隔离（推荐）

改动当前代码，按 userId 隔离会话和工作目录。

**改动点：**

1. `streamClaudeChat` 增加 `userId` 参数，使用 `workspace/{userId}/` 作为 cwd
2. `feishu.ts` 将 `senderId` 传递到 Claude 调用链
3. 首次使用时自动创建用户目录

**目录结构：**

```
/workspace/
  ├── ou_xxxx1/   ← 用户A（自动创建）
  ├── ou_xxxx2/   ← 用户B（自动创建）
  └── ou_xxxx3/   ← 用户C（自动创建）
```

**Docker 部署只需挂载总目录：**

```yaml
volumes:
  - ./workspace:/workspace
```

**优点：** 改动小、部署简单、资源占用低
**缺点：** 进程级别不隔离，共用一个 Claude Code 实例

### 方案二：每人一个 Docker 容器

一个飞书 Bot + 调度层 + 每个用户一个独立 Claude Code 容器。

**架构：**

```
飞书 WebSocket (1个)
       |
  路由/调度层 (1个容器)
       | 按 userId 分发
  +---------+---------+
  v         v         v
容器A     容器B     容器C
```

> 注意：飞书 Bot 的 WebSocket 连接只能有一个消费者，不能让每个容器各自连飞书，必须有一个调度层。

**优点：** 完全隔离（进程、文件系统、资源）
**缺点：** 需要容器编排和调度层，复杂度高，资源占用大

## 结论

对于大多数场景，**方案一**足够。只有需要进程级完全隔离时才考虑方案二。
